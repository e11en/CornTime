/* @Name xtorrent
*  @Version 0.1.1
*  @author Cobaimelan
*/

// required packages..
var cheerio = require('cheerio'),
	got     = require('got-promise');
	url     = "http://www.1337x.to";
var Q = require("q");

/**
 * search torrent
 * @param {str} object exam: New Girl S01E14
 * @param {next} function 
 */
function search(opt,next){
	opt.page = opt.page ? opt.page : 1;
	got('http://www.1337x.to/search/'+encodeURIComponent(opt.query)+'/'+opt.page+'/').then(function(data){

		 var $detail = cheerio.load(data.body); 

		 var $list = cheerio.load($detail('.tab-detail').children().last().html());

		  var list = [];
			$list('li').each(function(i, elem) {
				var chunk = cheerio.load($list(this).html());
				list[i] ={
					title :chunk('strong').text(),
					href:url+chunk('a').eq(1).attr('href'),
					seed:chunk('.green').text(),
					leech:chunk('.red').text(),
					size:chunk('.coll-4').text(),
					uploader:{
						name:chunk('.coll-5').text(),
						href:url+chunk('.coll-5 span a').attr('href')
					}
				}
			});


		 	next(null,list);

	},function (err) {
		next(err,null);
	})
}

/**
 *  torrent info
 * @param {urk} string exam: http://1337x.org/torrent/738327/New-Girl-S03E14-HDTV-x264-LOL/
 * @param {next} function 
 */

function info(url,next) {
	got(url).then(function(data){
		var $detail = cheerio.load(data.body); 
		var $content = cheerio.load($detail.html());

		var info =  {};

		info.title =$content('.top-row strong').text();


		info.category = $content('.category-detail ul.list li').eq(0).children('span').text().trim();
		info.type = $content('.category-detail ul.list li').eq(1).children('span').text().trim();
		info.language = $content('.category-detail ul.list li').eq(2).children('span').text().trim();
		info.size = $content('.category-detail ul.list li').eq(3).children('span').text().trim();
		info.uploaded = $content('.category-detail ul.list li').eq(4).children('span').text().trim();

		info.downloads =$content('.category-detail ul.list li').eq(5).children('span').text().trim();
		info.last_check =$content('.category-detail ul.list li').eq(6).children('span').text().trim();
		info.date_uploaded =$content('.category-detail ul.list li').eq(7).children('span').text().trim();
		info.seeders=$content('.category-detail ul.list li').eq(8).children('span').text().trim();
		info.leechers=$content('.category-detail ul.list li').eq(9).children('span').text().trim();

		info.download ={
			magnet:$content('.category-detail ul.download-links li').eq(0).children('a').attr('href'),
			file:$content('.category-detail ul.download-links li').eq(1).children('a').attr('href'),
			direct:$content('.category-detail ul.download-links li').eq(2).children('a').attr('href')
		}

			
		info.files = [];
		$content('.file-container ul').each(function (i,el) {
			info.files.push($content('.file-container ul').eq(i).children('li').text());
		})

		next(null,info);
	},function (err) {
		next(err,null);
	});

};

exports.search=search;
exports.info=info;